#!/usr/bin/env bash

usage () {
  echo "Usage: git fresh [-frsF] [remote] [root]"
  echo "-f: Delete stale local and remote branches"
  echo "-r: Rebase current branch against remote root"
  echo "-s: Apply stashed changes after run"
  echo "-F: Reset local root to remote root, wipe workspace"
  echo "remote: remote name, default is origin"
  echo "root: root branch, default is master"
  exit 1;
}

while getopts "fsrF" opt; do
  case $opt in
    f)
      FORCE_DELETE_STALE=true
      ;;
    s)
      APPLY_STASH=true
      ;;
    r)
      REBASE=true
      ;;
    F)
      FORCE_LOCAL_RESET=true
      ;;
    *)
      usage
      ;;
  esac
done

shift $((OPTIND-1))

CURRENT=$(git rev-parse --abbrev-ref HEAD)
REMOTE=${1:-origin}
ROOT=${2:-master}

git remote update
git remote prune $REMOTE

STASH_STAMP=git-fresh-$(date +%s)
git stash save -q $STASH_STAMP
git checkout $ROOT 2> /dev/null

STALE=$(git branch -r --merged | grep $REMOTE | grep -Ev ">|$ROOT")
STALE=${STALE//$REMOTE\/}
ORPHANS=$(git branch --merged $REMOTE/$ROOT | grep -v "$ROOT")

if [[ ! -z "${STALE// }" ]]; then
  if [[ "$FORCE_DELETE_STALE" = true ]]; then
    echo -n $STALE | xargs git branch -d 2> /dev/null
    echo -n $STALE | xargs git push $REMOTE --delete
  else
    echo "Stale branches found:" $(echo -n $STALE | tr -s "\r\n" " " | tr -s " ")
    echo "Delete stale branches with: git fresh -f"
  fi
fi

if [[ ! -z "${ORPHANS// }" ]]; then
  if [[ "$FORCE_DELETE_STALE" = true ]]; then
    echo -n $ORPHANS | xargs git branch -d 2> /dev/null
  else
    echo "Orphan branches found:" $(echo -n $ORPHANS | tr -s "\r\n" " " | tr -s " ")
    echo "Delete orphan branches with: git fresh -f"
  fi
fi

SMART_STALE=$(git branch -a --merged $REMOTE/$ROOT | grep -Ev ">|master|\*" | tr -s " " "\n")

if [[ "$SMART_STALE_ENABLED" == "true" ]]; then
  printf $SMART_STALE
  echo "SS Local branches found:"
  echo $(printf $SMART_STALE | grep -v 'remotes/')
  echo "SS Remote branches found:"
  echo $(printf $SMART_STALE | grep 'remotes/')
fi

if [[ "$FORCE_LOCAL_RESET" = true ]]; then
  git clean -dfx
  git reset --hard $REMOTE/$ROOT
else
  git rebase -q $REMOTE/$ROOT
fi

if [[ ! -z $(git rev-parse --verify --quiet "$CURRENT") ]]; then
  git checkout $CURRENT 2> /dev/null
  if [[ "$REBASE" = true ]]; then
    git rebase $REMOTE/$ROOT
  fi
else
  echo "$CURRENT branch was stale, staying on $ROOT"
fi

if [[ ! -z $(git stash list | grep $STASH_STAMP) ]]; then
  if [[ "$APPLY_STASH" = true ]]; then
    git stash pop
  else
    echo "Stashed changes present, apply with: git stash pop"
  fi
fi

git gc --auto --prune=now
